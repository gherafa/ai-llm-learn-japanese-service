name: Manual Deploy to Local k3d (GHCR)


on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag (default: latest)'
        required: false


jobs:
  build_and_deploy:
    # IMPORTANT: use a self-hosted runner that has Docker and kubectl access to your local k3d cluster.
    runs-on: self-hosted


    steps:
    - name: Checkout
      uses: actions/checkout@v4


    - name: Debug Secrets
      run: |
        echo "Actor: ${{ github.actor }}"
        echo "Repository Owner: ${{ github.repository_owner }}"
        echo "Username Secret: ${{ secrets.GHCR_USERNAME }}"
        echo "Token set? $([[ -n "${{ secrets.GHCR_TOKEN }}" ]] && echo YES || echo NO)" 
 
    - name: Login to GHCR
      run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin


    - name: Build Docker image
      run: |
        TAG=${{ github.event.inputs.tag || 'latest' }}
        IMAGE=ghcr.io/${{ secrets.GHCR_USERNAME }}/${{ github.repository }}:${TAG}
        docker build -t $IMAGE .
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV


    - name: Push Docker image
      run: |
        docker push $IMAGE


    - name: Create GHCR pull secret in cluster (if not exists)
      env:
        GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
        GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      run: |
        kubectl get secret ghcr-secret || kubectl create secret docker-registry ghcr-secret \
        --docker-server=ghcr.io --docker-username="$GHCR_USERNAME" --docker-password="$GHCR_TOKEN" --docker-email=devnull@example.com


    - name: Deploy (set image)
      run: |
        kubectl set image deployment/backend backend=$IMAGE --record || kubectl apply -f k8s/deployment.yaml
        kubectl rollout status deployment/backend --timeout=120s